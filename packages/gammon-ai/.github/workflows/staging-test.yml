name: Staging Deployment and Test
on: [push]
jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Backend setup
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
    - name: Install backend dependencies
      run: npm install
      working-directory: ./
    - name: Run migrations
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb

    # Frontend setup
    - name: Install frontend dependencies
      run: npm install
      working-directory: guru-react
    - name: Build frontend
      run: npm run build
      working-directory: guru-react
    - name: Start frontend server
      run: npm run preview &
      working-directory: guru-react

    # Run tests
    - name: Run Playwright tests
      uses: microsoft/playwright-github-action@v1
      with:
        working-directory: guru-react
